<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Plant Pairing Network</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        #sidebar {
            width: 320px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .controls {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .section {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        
        #search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        .legend-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #fff;
        }
        
        #plant-details {
            flex: 1;
            overflow-y: auto;
        }
        
        .detail-section {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .detail-section h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        
        .detail-section p {
            margin: 0;
            font-size: 12px;
            line-height: 1.5;
            color: #4b5563;
        }
        
        .detail-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        
        .companion-list {
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0;
        }
        
        .companion-list li {
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        #graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #graph {
            background: white;
        }
        
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node.primary {
            stroke-width: 2.5px;
        }
        
        .node.highlighted {
            stroke: #f59e0b;
            stroke-width: 4px;
        }
        
        .node.dimmed {
            opacity: 0.2;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.2;
            stroke-width: 1px;
        }
        
        .link.highlighted {
            stroke: #f59e0b;
            stroke-opacity: 0.8;
            stroke-width: 2px;
        }
        
        .link.dimmed {
            opacity: 0.05;
        }
        
        text {
            font-size: 9px;
            pointer-events: none;
            text-anchor: middle;
            fill: #333;
            font-weight: 500;
        }
        
        text.primary-label {
            font-size: 10px;
            font-weight: 600;
        }
        
        text.dimmed {
            opacity: 0.2;
        }
        
        .stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 12px;
        }
        
        .timeline {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .timeline h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        .timeline-bar {
            position: relative;
            height: 30px;
            margin-bottom: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .timeline-label {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            z-index: 1;
        }
        
        .timeline-months {
            display: flex;
            margin-bottom: 10px;
            font-size: 10px;
            color: #6b7280;
        }
        
        .timeline-month {
            flex: 1;
            text-align: center;
            padding: 4px 0;
            border-right: 1px solid #e5e7eb;
        }
        
        .timeline-month:last-child {
            border-right: none;
        }
        
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 13px;
        }
        
        #clear-selection {
            width: 100%;
            padding: 8px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }
        
        #clear-selection:hover {
            background: #e5e7eb;
        }
        
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 18px;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #f3f4f6;
        }
        
        .zoom-btn:first-child {
            border-radius: 6px 6px 0 0;
        }
        
        .zoom-btn:last-child {
            border-radius: 0 0 6px 6px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="section">
            <h3>Search & Filter</h3>
            <input type="text" id="search-box" placeholder="Search plants...">
            
            <button id="clear-selection" style="margin-top: 15px;">Clear Selection</button>
            
            <div class="color-legend">
                <div style="font-size: 11px; font-weight: 600; width: 100%; margin-bottom: 5px;">Bloom Time Colors:</div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #fef3c7;"></span>
                    Early Spring
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #fde68a;"></span>
                    Late Spring
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #fb923c;"></span>
                    Early Summer
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #f472b6;"></span>
                    Mid Summer
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #a78bfa;"></span>
                    Late Summer
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #c084fc;"></span>
                    Fall
                </div>
                <div class="legend-item">
                    <span class="legend-circle" style="background: #d1d5db;"></span>
                    No Data
                </div>
            </div>
            
            <div class="stats" id="stats"></div>
        </div>
        
        <div id="plant-details">
            <div class="empty-state">
                <p>Click a plant to see details</p>
            </div>
        </div>
    </div>
    
    <div id="main-content">
        <div id="graph-container">
            <svg id="graph"></svg>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-in">+</button>
                <button class="zoom-btn" id="zoom-reset">⊙</button>
                <button class="zoom-btn" id="zoom-out">−</button>
            </div>
        </div>
        
        <div class="timeline" id="timeline" style="display: none;">
            <h3>Bloom Timeline for Selected Plants</h3>
            <div class="timeline-months">
                <div class="timeline-month">Apr</div>
                <div class="timeline-month">May</div>
                <div class="timeline-month">Jun</div>
                <div class="timeline-month">Jul</div>
                <div class="timeline-month">Aug</div>
                <div class="timeline-month">Sep</div>
                <div class="timeline-month">Oct</div>
            </div>
            <div id="timeline-content"></div>
        </div>
    </div>

    <script>
        // Plant database will be loaded here
        let plantDatabase = {};
        
        // Parse CSV data
        const csvData = `Primary Plant,Companion 1,Companion 2,Companion 3,Companion 4,Companion 5
Achillea millefolium,Schizachyrium scoparium,Asclepias tuberosa,Rudbeckia hirta,Penstemon digitalis,Monarda fistulosa
Amelanchier laevis,Cornus alternifolia,Viburnum lentago,Aronia melanocarpa,Diervilla lonicera,Carex pensylvanica
Anaphalis margaritacea,Solidago ptarmicoides,Schizachyrium scoparium,Sporobolus cryptandrus,Viola adunca,Asclepias tuberosa
Antennaria plantaginifolia,Carex pensylvanica,Viola pedata,Sisyrinchium angustifolium,Liatris cylindracea,Schizachyrium scoparium
Asclepias incarnata,Iris versicolor,Eupatorium perfoliatum,Lobelia cardinalis,Chelone glabra,Carex stricta
Bouteloua curtipendula,Schizachyrium scoparium,Solidago nemoralis,Liatris cylindracea,Asclepias tuberosa,Penstemon digitalis
Calamagrostis canadensis,Iris versicolor,Eupatorium perfoliatum,Spiraea alba,Carex stricta,Lobelia cardinalis
Carex bebbii,Iris versicolor,Lobelia cardinalis,Eupatorium perfoliatum,Calamagrostis canadensis,Spiraea alba
Carex gracilima,Polystichum acrostichoides,Thalictrum dioicum,Viola canadensis,Aquilegia canadensis,Eurybia macrophylla
Carex pensylvanica,Gaultheria procumbens,Antennaria plantaginifolia,Vaccinium angustifolium,Maianthemum canadense,Fragaria virginiana
Carex rosea,Polystichum acrostichoides,Aquilegia canadensis,Thalictrum dioicum,Viola sororia,Geranium maculatum
Carex sparganioides,Polystichum acrostichoides,Aquilegia canadensis,Eurybia macrophylla,Solidago flexicaulis,Thalictrum dioicum
Carex vulpinoidea,Eupatorium perfoliatum,Chelone glabra,Iris versicolor,Lobelia siphilitica,Carex stricta
Chelone glabra,Iris versicolor,Lobelia siphilitica,Asclepias incarnata,Eupatorium perfoliatum,Carex vulpinoidea
Coreopsis lanceolata,Schizachyrium scoparium,Rudbeckia hirta,Penstemon digitalis,Echinacea pallida,Bouteloua curtipendula
Cornus alternifolia,Amelanchier laevis,Viburnum lentago,Polystichum acrostichoides,Eurybia macrophylla,Thalictrum dioicum
Cornus sericea,Spiraea alba,Calamagrostis canadensis,Iris versicolor,Lobelia cardinalis,Eupatorium perfoliatum
Diervilla lonicera,Carex pensylvanica,Gaultheria procumbens,Polystichum acrostichoides,Thalictrum dioicum,Viola sororia
Echinacea pallida,Schizachyrium scoparium,Liatris aspera,Coreopsis lanceolata,Asclepias tuberosa,Rudbeckia hirta
Elymus hystrix,Polystichum acrostichoides,Thalictrum dioicum,Eurybia macrophylla,Solidago flexicaulis,Carex gracilima
Eupatorium perfoliatum,Iris versicolor,Lobelia cardinalis,Calamagrostis canadensis,Mimulus ringens,Carex lupulina
Eutrochium maculatum,Lobelia cardinalis,Iris versicolor,Asclepias incarnata,Eupatorium perfoliatum,Calamagrostis canadensis
Fragaria virginiana,Viola sororia,Phlox divaricata,Thalictrum dioicum,Aquilegia canadensis,Polystichum acrostichoides
Gaultheria procumbens,Vaccinium angustifolium,Cornus canadensis,Mitchella repens,Polystichum acrostichoides,Carex pensylvanica
Geum triflorum,Antennaria plantaginifolia,Phlox divaricata,Viola sororia,Thalictrum dioicum,Fragaria virginiana
Ilex verticillata,Calamagrostis canadensis,Spiraea alba,Lobelia cardinalis,Iris versicolor,Carex stricta
Iris versicolor,Asclepias incarnata,Eupatorium perfoliatum,Lobelia cardinalis,Mimulus ringens,Carex stricta
Liatris aspera,Schizachyrium scoparium,Asclepias tuberosa,Solidago ptarmicoides,Echinacea pallida,Penstemon digitalis
Monarda fistulosa,Schizachyrium scoparium,Echinacea pallida,Liatris aspera,Penstemon digitalis,Rudbeckia hirta
Morella pensylvanica,Carex pensylvanica,Gaultheria procumbens,Vaccinium angustifolium,Comptonia peregrina,Schizachyrium scoparium
Myrica gale,Osmunda regalis,Carex stricta,Iris versicolor,Spiraea alba,Calamagrostis canadensis
Penstemon digitalis,Schizachyrium scoparium,Solidago nemoralis,Asclepias tuberosa,Coreopsis lanceolata,Liatris cylindracea
Penstemon hirsutus,Schizachyrium scoparium,Liatris cylindracea,Solidago ptarmicoides,Asclepias tuberosa,Bouteloua curtipendula
Phlox divaricata,Thalictrum dioicum,Aquilegia canadensis,Polystichum acrostichoides,Viola canadensis,Geranium maculatum
Physocarpus opulifolius,Cornus sericea,Spiraea alba,Amelanchier laevis,Viburnum lentago,Carex stricta
Polystichum acrostichoides,Thalictrum dioicum,Aquilegia canadensis,Carex plantaginea,Viola canadensis,Solidago flexicaulis
Pycnanthemum tenuifolium,Monarda fistulosa,Schizachyrium scoparium,Liatris aspera,Solidago nemoralis,Echinacea pallida
Rubus odoratus,Polystichum acrostichoides,Thalictrum dioicum,Eurybia macrophylla,Solidago flexicaulis,Carex gracilima
Rudbeckia hirta,Schizachyrium scoparium,Solidago nemoralis,Coreopsis lanceolata,Penstemon digitalis,Asclepias tuberosa
Schizachyrium scoparium,Solidago nemoralis,Bouteloua curtipendula,Liatris cylindracea,Solidago ptarmicoides,Asclepias tuberosa
Shepherdia canadensis,Morella pensylvanica,Amelanchier laevis,Carex pensylvanica,Juniperus virginiana,Cornus alternifolia
Solidago flexicaulis,Polystichum acrostichoides,Eurybia macrophylla,Thalictrum dioicum,Carex sparganioides,Geranium maculatum
Solidago nemoralis,Schizachyrium scoparium,Bouteloua curtipendula,Asclepias tuberosa,Liatris cylindracea,Solidago ptarmicoides
Solidago ptarmicoides,Schizachyrium scoparium,Solidago nemoralis,Liatris cylindracea,Asclepias tuberosa,Anaphalis margaritacea
Solidago rugosa,Eupatorium perfoliatum,Iris versicolor,Asclepias incarnata,Calamagrostis canadensis,Lobelia cardinalis
Spiraea alba,Calamagrostis canadensis,Iris versicolor,Asclepias incarnata,Carex stricta,Lobelia cardinalis
Symphyotrichum cordifolium,Solidago flexicaulis,Eurybia macrophylla,Polystichum acrostichoides,Thalictrum dioicum,Carex sparganioides
Symphyotrichum novae-angliae,Panicum virgatum,Liatris spicata,Monarda fistulosa,Rudbeckia hirta,Solidago rugosa
Symphyotrichum oolentangiense,Schizachyrium scoparium,Solidago ptarmicoides,Liatris aspera,Penstemon digitalis,Asclepias tuberosa
Thalictrum dioicum,Polystichum acrostichoides,Aquilegia canadensis,Carex plantaginea,Phlox divaricata,Viola canadensis
Tradescantia ohiensis,Schizachyrium scoparium,Penstemon hirsutus,Liatris cylindracea,Monarda fistulosa,Rudbeckia hirta
Viola canadensis,Polystichum acrostichoides,Thalictrum dioicum,Aquilegia canadensis,Carex gracilima,Solidago flexicaulis`;

        // Load and process plant database JSON
        fetch('plant-database.json')
            .then(response => response.json())
            .then(data => {
                // Index by Name
                data.forEach(plant => {
                    if (plant.Name) {
                        plantDatabase[plant.Name] = plant;
                    }
                });
                console.log('Loaded plant database:', Object.keys(plantDatabase).length, 'plants');
                initializeGraph();
            })
            .catch(error => {
                console.error('Error loading plant database:', error);
                initializeGraph(); // Continue without database
            });

        function initializeGraph() {
            // Process the CSV data
            const lines = csvData.trim().split('\n');
            const nodes = new Map();
            const links = [];
            const primaryPlants = new Set();

            lines.slice(1).forEach(line => {
                const parts = line.split(',');
                const primary = parts[0];
                primaryPlants.add(primary);
                
                if (!nodes.has(primary)) {
                    const plantData = plantDatabase[primary] || {};
                    nodes.set(primary, { 
                        id: primary,
                        type: 'primary',
                        connections: 0,
                        data: plantData
                    });
                }
                
                for (let i = 1; i < parts.length; i++) {
                    const companion = parts[i];
                    if (companion) {
                        if (!nodes.has(companion)) {
                            const plantData = plantDatabase[companion] || {};
                            nodes.set(companion, { 
                                id: companion,
                                type: 'companion',
                                connections: 0,
                                data: plantData
                            });
                        }
                        
                        links.push({
                            source: primary,
                            target: companion
                        });
                        
                        nodes.get(primary).connections++;
                        nodes.get(companion).connections++;
                    }
                }
            });

            const nodesArray = Array.from(nodes.values());
            
            // Calculate stats
            const totalConnections = links.length;
            const uniqueCompanions = nodesArray.filter(n => n.type === 'companion').length;
            const avgConnectionsPerPrimary = (totalConnections / primaryPlants.size).toFixed(1);
            
            document.getElementById('stats').innerHTML = `
                <strong>Network Stats:</strong><br>
                ${primaryPlants.size} primary plants<br>
                ${uniqueCompanions} unique companions<br>
                ${totalConnections} total connections<br>
                ${avgConnectionsPerPrimary} avg per primary
            `;

            // Set up SVG
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select('#graph')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g');

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 1.3);
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                svg.transition().call(zoom.scaleBy, 0.7);
            });
            
            document.getElementById('zoom-reset').addEventListener('click', () => {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            });

            // Helper functions
            function getHeightCategory(heightStr) {
                if (!heightStr) return 'medium';
                const lower = heightStr.toLowerCase();
                if (lower.includes('groundcover') || lower.includes('< 1')) return 'groundcover';
                if (lower.includes('low') || lower.includes('1-2')) return 'low';
                if (lower.includes('medium') || lower.includes('2-4') || lower.includes('3-6')) return 'medium';
                if (lower.includes('tall') || lower.includes('4-8') || lower.includes('5-10')) return 'tall';
                if (lower.includes('tree') || lower.includes('8+') || lower.includes('10+')) return 'tree';
                return 'medium';
            }

            function getNodeRadius(heightCategory, isPrimary) {
                const baseSize = isPrimary ? 2 : 1;
                const sizes = {
                    'groundcover': 4 + baseSize,
                    'low': 6 + baseSize,
                    'medium': 8 + baseSize,
                    'tall': 11 + baseSize,
                    'tree': 14 + baseSize
                };
                return sizes[heightCategory] || sizes.medium;
            }

            function getBloomColor(bloomTime) {
                if (!bloomTime) return '#d1d5db';
                const lower = bloomTime.toLowerCase();
                if (lower.includes('early') && lower.includes('spring')) return '#fef3c7';
                if (lower.includes('late') && lower.includes('spring')) return '#fde68a';
                if (lower.includes('early') && lower.includes('summer')) return '#fb923c';
                if (lower.includes('mid') && lower.includes('summer')) return '#f472b6';
                if (lower.includes('late') && lower.includes('summer')) return '#a78bfa';
                if (lower.includes('fall')) return '#c084fc';
                return '#d1d5db';
            }

            function normalizeBloomTime(bloomTime) {
                if (!bloomTime) return null;
                const lower = bloomTime.toLowerCase();
                if (lower.includes('early') && lower.includes('spring')) return 'early-spring';
                if (lower.includes('late') && lower.includes('spring')) return 'late-spring';
                if (lower.includes('early') && lower.includes('summer')) return 'early-summer';
                if (lower.includes('mid') && lower.includes('summer')) return 'mid-summer';
                if (lower.includes('late') && lower.includes('summer')) return 'late-summer';
                if (lower.includes('fall')) return 'fall';
                return null;
            }

            // Add height and bloom info to nodes
            nodesArray.forEach(node => {
                node.heightCategory = getHeightCategory(node.data.Height);
                node.bloomTime = normalizeBloomTime(node.data['Bloom time']);
                node.bloomColor = getBloomColor(node.data['Bloom time']);
                node.radius = getNodeRadius(node.heightCategory, node.type === 'primary');
            });

            // Create force simulation
            const simulation = d3.forceSimulation(nodesArray)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(100)
                    .strength(0.5))
                .force('charge', d3.forceManyBody()
                    .strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.radius + 5))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));

            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link');

            // Create nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(nodesArray)
                .join('circle')
                .attr('class', d => `node ${d.type}`)
                .attr('r', d => d.radius)
                .attr('fill', d => d.bloomColor)
                .call(drag(simulation));

            // Create labels
            const label = g.append('g')
                .selectAll('text')
                .data(nodesArray)
                .join('text')
                .attr('class', d => d.type === 'primary' ? 'primary-label' : '')
                .text(d => {
                    const parts = d.id.split(' ');
                    return parts[0] + (parts[1] ? ' ' + parts[1].substring(0, 3) + '.' : '');
                })
                .attr('dy', -12);

            let selectedNode = null;

            // Node click handler
            node.on('click', function(event, d) {
                event.stopPropagation();
                selectedNode = d;
                
                // Reset all
                node.classed('highlighted', false).classed('dimmed', false);
                link.classed('highlighted', false).classed('dimmed', false);
                label.classed('dimmed', false);
                
                // Find connected node IDs
                const connectedIds = new Set([d.id]);
                links.forEach(l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    
                    if (sourceId === d.id) connectedIds.add(targetId);
                    if (targetId === d.id) connectedIds.add(sourceId);
                });
                
                // Highlight connected
                node.classed('highlighted', n => connectedIds.has(n.id))
                    .classed('dimmed', n => !connectedIds.has(n.id));
                
                label.classed('dimmed', n => !connectedIds.has(n.id));
                
                link.classed('highlighted', l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return sourceId === d.id || targetId === d.id;
                }).classed('dimmed', l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return sourceId !== d.id && targetId !== d.id;
                });
                
                showPlantDetails(d);
                updateTimeline([d, ...Array.from(connectedIds).filter(id => id !== d.id).map(id => nodesArray.find(n => n.id === id))]);
            });

            // Clear selection
            svg.on('click', () => {
                if (event.target.tagName === 'svg') {
                    clearSelection();
                }
            });

            document.getElementById('clear-selection').addEventListener('click', clearSelection);

            function clearSelection() {
                selectedNode = null;
                node.classed('highlighted', false).classed('dimmed', false);
                link.classed('highlighted', false).classed('dimmed', false);
                label.classed('dimmed', false);
                document.getElementById('plant-details').innerHTML = '<div class="empty-state"><p>Click a plant to see details</p></div>';
                document.getElementById('timeline').style.display = 'none';
            }

            function showPlantDetails(d, compareWith = null) {
                const data = d.data;
                const companions = links
                    .filter(l => {
                        const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                        const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                        return sourceId === d.id || targetId === d.id;
                    })
                    .map(l => {
                        const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                        const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                        return sourceId === d.id ? targetId : sourceId;
                    })
                    .filter(id => id !== d.id);

                if (compareWith) {
                    // Show comparison view
                    const compareData = compareWith.data;
                    const html = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="border-right: 1px solid #e5e7eb; padding-right: 10px;">
                                <div class="detail-section">
                                    <h4>${d.id}</h4>
                                    <p style="font-size: 11px;">${data['Common Name'] || 'Common name not available'}</p>
                                </div>
                                
                                <div class="detail-section">
                                    <div class="detail-label">Visual</div>
                                    <p><strong>Type:</strong> ${data.Type || 'Unknown'}</p>
                                    <p><strong>Height:</strong> ${data.Height || 'Unknown'}</p>
                                    <p><strong>Bloom Time:</strong> ${data['Bloom time'] || 'Unknown'}</p>
                                    <p><strong>Bloom Color:</strong> ${data['Bloom color'] || 'Unknown'}</p>
                                    ${data.Layer ? `<p><strong>Layer:</strong> ${data.Layer}</p>` : ''}
                                </div>
                                
                                <div class="detail-section">
                                    <div class="detail-label">Growing</div>
                                    <p><strong>Sun:</strong> ${data.Sun || 'Unknown'}</p>
                                    <p><strong>Moisture:</strong> ${data.Moisture || 'Unknown'}</p>
                                    ${data['pH Requirements'] ? `<p><strong>pH:</strong> ${data['pH Requirements']}</p>` : ''}
                                </div>
                            </div>
                            
                            <div style="padding-left: 10px;">
                                <div class="detail-section">
                                    <h4>${compareWith.id}</h4>
                                    <p style="font-size: 11px;">${compareData['Common Name'] || 'Common name not available'}</p>
                                </div>
                                
                                <div class="detail-section">
                                    <div class="detail-label">Visual</div>
                                    <p><strong>Type:</strong> ${compareData.Type || 'Unknown'}</p>
                                    <p><strong>Height:</strong> ${compareData.Height || 'Unknown'}</p>
                                    <p><strong>Bloom Time:</strong> ${compareData['Bloom time'] || 'Unknown'}</p>
                                    <p><strong>Bloom Color:</strong> ${compareData['Bloom color'] || 'Unknown'}</p>
                                    ${compareData.Layer ? `<p><strong>Layer:</strong> ${compareData.Layer}</p>` : ''}
                                </div>
                                
                                <div class="detail-section">
                                    <div class="detail-label">Growing</div>
                                    <p><strong>Sun:</strong> ${compareData.Sun || 'Unknown'}</p>
                                    <p><strong>Moisture:</strong> ${compareData.Moisture || 'Unknown'}</p>
                                    ${compareData['pH Requirements'] ? `<p><strong>pH:</strong> ${compareData['pH Requirements']}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <button onclick="showSinglePlant('${d.id}')" style="width: 100%; padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">Back to ${d.id}</button>
                        </div>
                    `;
                    document.getElementById('plant-details').innerHTML = html;
                } else {
                    // Show single plant view
                    const html = `
                        <div class="detail-section">
                            <h4>${d.id}</h4>
                            <p>${data['Common Name'] || 'Common name not available'}</p>
                        </div>
                        
                        ${data.Description ? `
                        <div class="detail-section">
                            <div class="detail-label">Description</div>
                            <p>${data.Description}</p>
                        </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <div class="detail-label">Visual Attributes</div>
                            <p><strong>Type:</strong> ${data.Type || 'Unknown'}</p>
                            <p><strong>Height:</strong> ${data.Height || 'Unknown'}</p>
                            <p><strong>Bloom Time:</strong> ${data['Bloom time'] || 'Unknown'}</p>
                            <p><strong>Bloom Color:</strong> ${data['Bloom color'] || 'Unknown'}</p>
                            ${data.Layer ? `<p><strong>Layer:</strong> ${data.Layer}</p>` : ''}
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Growing Conditions</div>
                            <p><strong>Sun:</strong> ${data.Sun || 'Unknown'}</p>
                            <p><strong>Moisture:</strong> ${data.Moisture || 'Unknown'}</p>
                            ${data['pH Requirements'] ? `<p><strong>pH:</strong> ${data['pH Requirements']}</p>` : ''}
                        </div>
                        
                        ${data.Habit ? `
                        <div class="detail-section">
                            <div class="detail-label">Habit</div>
                            <p>${data.Habit}</p>
                        </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <div class="detail-label">Companion Plants (${companions.length})</div>
                            <ul class="companion-list">
                                ${companions.slice(0, 10).map(c => `<li style="cursor: pointer; color: #2563eb;" onclick="compareWithCompanion('${d.id}', '${c}')">${c}</li>`).join('')}
                                ${companions.length > 10 ? `<li><em>... and ${companions.length - 10} more</em></li>` : ''}
                            </ul>
                        </div>
                    `;
                    document.getElementById('plant-details').innerHTML = html;
                }
            }

            // Helper functions for comparison
            window.compareWithCompanion = function(primaryId, companionId) {
                const primaryNode = nodesArray.find(n => n.id === primaryId);
                const companionNode = nodesArray.find(n => n.id === companionId);
                if (primaryNode && companionNode) {
                    showPlantDetails(primaryNode, companionNode);
                }
            };

            window.showSinglePlant = function(plantId) {
                const plantNode = nodesArray.find(n => n.id === plantId);
                if (plantNode) {
                    showPlantDetails(plantNode);
                }
            };

            function updateTimeline(plants) {
                const bloomMonths = {
                    'early-spring': [0, 1],      // Apr-May
                    'late-spring': [1, 2],       // May-Jun
                    'early-summer': [2, 3],      // Jun-Jul
                    'mid-summer': [3, 4],        // Jul-Aug
                    'late-summer': [4, 5],       // Aug-Sep
                    'fall': [5, 6]               // Sep-Oct
                };

                const plantsWithBloom = plants.filter(p => p && p.bloomTime).slice(0, 15);

                if (plantsWithBloom.length === 0) {
                    document.getElementById('timeline').style.display = 'none';
                    return;
                }

                document.getElementById('timeline').style.display = 'block';

                const html = plantsWithBloom.map(p => {
                    const months = bloomMonths[p.bloomTime] || [0, 0];
                    const startPct = (months[0] / 7) * 100;
                    const widthPct = ((months[1] - months[0]) / 7) * 100;
                    
                    return `
                        <div class="timeline-bar" style="background: linear-gradient(90deg, transparent ${startPct}%, ${p.bloomColor} ${startPct}%, ${p.bloomColor} ${startPct + widthPct}%, transparent ${startPct + widthPct}%);">
                            <div class="timeline-label">${p.id.split(' ')[0]} ${p.id.split(' ')[1]?.substring(0, 3) || ''}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('timeline-content').innerHTML = html;
            }

            // Search and filter
            const searchBox = document.getElementById('search-box');

            function applyFilters() {
                const searchTerm = searchBox.value.toLowerCase();

                node.style('display', d => {
                    const matchesSearch = !searchTerm || d.id.toLowerCase().includes(searchTerm) || 
                                         (d.data['Common Name'] || '').toLowerCase().includes(searchTerm);
                    
                    return matchesSearch ? null : 'none';
                });

                label.style('display', d => {
                    const matchesSearch = !searchTerm || d.id.toLowerCase().includes(searchTerm) || 
                                         (d.data['Common Name'] || '').toLowerCase().includes(searchTerm);
                    
                    return matchesSearch ? null : 'none';
                });
            }

            searchBox.addEventListener('input', applyFilters);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // Drag behavior
            function drag(simulation) {
                function dragstarted(event) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                }

                function dragged(event) {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                }

                function dragended(event) {
                    if (!event.active) simulation.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                }

                return d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended);
            }
        }
    </script>
</body>
</html>
