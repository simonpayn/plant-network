<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Pairing Network - Detailed View</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        #sidebar {
            width: 350px;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 20px;
        }
        
        #sidebar h3 {
            margin-top: 0;
            color: #1f2937;
        }
        
        #sidebar.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            text-align: center;
        }
        
        .plant-detail {
            margin-bottom: 20px;
        }
        
        .plant-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .plant-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .plant-type.primary {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .plant-type.companion {
            background: #d1fae5;
            color: #065f46;
        }
        
        .connections-list {
            margin-top: 16px;
        }
        
        .connection-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #10b981;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-item:hover {
            background: #f3f4f6;
            border-left-color: #059669;
        }
        
        .connection-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .connection-meta {
            font-size: 12px;
            color: #6b7280;
        }
        
        .ecological-group {
            display: inline-block;
            padding: 2px 6px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 4px;
        }
        
        #graph {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls h2 {
            margin: 0 0 8px 0;
            font-size: 20px;
        }
        
        .controls p {
            margin: 0 0 8px 0;
            color: #6b7280;
            font-size: 14px;
        }
        
        .node {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.2s;
        }
        
        .node.primary {
            fill: #2563eb;
        }
        
        .node.companion {
            fill: #10b981;
        }
        
        .node.highlighted {
            stroke: #f59e0b;
            stroke-width: 4px;
        }
        
        .node:hover {
            stroke: #f59e0b;
            stroke-width: 3px;
        }
        
        .link {
            stroke: #d1d5db;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }
        
        .link.highlighted {
            stroke: #f59e0b;
            stroke-opacity: 0.8;
            stroke-width: 2.5px;
        }
        
        text {
            font-size: 11px;
            pointer-events: none;
            text-anchor: middle;
            fill: #374151;
            font-weight: 500;
        }
        
        .stats {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 13px;
        }
        
        .filter-group {
            margin: 12px 0;
        }
        
        .filter-btn {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px 4px 4px 0;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: #e5e7eb;
        }
        
        .filter-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="main-content">
        <div class="controls">
            <h2>Plant Pairing Network - Detailed View</h2>
            <p>Click any node to see its connections and ecological details in the sidebar â†’</p>
            <div class="filter-group">
                <strong>Filter by ecological group:</strong><br>
                <button class="filter-btn active" data-group="all">All Plants</button>
                <button class="filter-btn" data-group="dry-prairie">Dry Prairie</button>
                <button class="filter-btn" data-group="moist-meadow">Moist Meadow</button>
                <button class="filter-btn" data-group="woodland">Woodland</button>
                <button class="filter-btn" data-group="transitional">Transitional</button>
            </div>
            <div class="stats" id="stats"></div>
        </div>
        <svg id="graph"></svg>
    </div>
    
    <div id="sidebar" class="empty">
        <p>Click a plant node to view its companions and ecological relationships</p>
    </div>

    <script>
        // Ecological groupings based on the batch organization
        const ecologicalGroups = {
            'Schizachyrium scoparium': 'dry-prairie',
            'Coreopsis lanceolata': 'dry-prairie',
            'Solidago nemoralis': 'dry-prairie',
            'Rudbeckia hirta': 'dry-prairie',
            'Bouteloua curtipendula': 'dry-prairie',
            'Asclepias tuberosa': 'dry-prairie',
            'Liatris cylindracea': 'dry-prairie',
            'Liatris aspera': 'dry-prairie',
            'Solidago ptarmicoides': 'dry-prairie',
            'Echinacea pallida': 'dry-prairie',
            
            'Asclepias incarnata': 'moist-meadow',
            'Eupatorium perfoliatum': 'moist-meadow',
            'Spiraea alba': 'moist-meadow',
            'Chelone glabra': 'moist-meadow',
            'Iris versicolor': 'moist-meadow',
            'Lobelia cardinalis': 'moist-meadow',
            'Lobelia siphilitica': 'moist-meadow',
            'Carex stricta': 'moist-meadow',
            'Carex vulpinoidea': 'moist-meadow',
            'Carex lupulina': 'moist-meadow',
            'Calamagrostis canadensis': 'moist-meadow',
            'Mimulus ringens': 'moist-meadow',
            
            'Carex rosea': 'woodland',
            'Polystichum acrostichoides': 'woodland',
            'Thalictrum dioicum': 'woodland',
            'Gaultheria procumbens': 'woodland',
            'Aquilegia canadensis': 'woodland',
            'Viola sororia': 'woodland',
            'Viola canadensis': 'woodland',
            'Geranium maculatum': 'woodland',
            'Carex plantaginea': 'woodland',
            'Solidago flexicaulis': 'woodland',
            'Phlox divaricata': 'woodland',
            'Eurybia macrophylla': 'woodland',
            'Vaccinium angustifolium': 'woodland',
            'Cornus canadensis': 'woodland',
            'Mitchella repens': 'woodland',
            'Carex pensylvanica': 'woodland',
            
            'Carex sparganioides': 'transitional',
            'Penstemon digitalis': 'transitional',
            'Symphyotrichum oolentangiense': 'transitional',
            'Diervilla lonicera': 'transitional',
            'Fragaria virginiana': 'transitional'
        };

        const groupColors = {
            'dry-prairie': '#f59e0b',
            'moist-meadow': '#3b82f6',
            'woodland': '#10b981',
            'transitional': '#8b5cf6'
        };

        const groupNames = {
            'dry-prairie': 'Dry Prairie',
            'moist-meadow': 'Moist Meadow',
            'woodland': 'Woodland',
            'transitional': 'Transitional'
        };

        // Parse CSV data
        const csvData = `Primary Plant,Companion 1,Companion 2,Companion 3,Companion 4,Companion 5
Schizachyrium scoparium,Solidago nemoralis,Bouteloua curtipendula,Liatris cylindracea,Solidago ptarmicoides,Asclepias tuberosa
Coreopsis lanceolata,Schizachyrium scoparium,Rudbeckia hirta,Penstemon digitalis,Echinacea pallida,Bouteloua curtipendula
Solidago nemoralis,Schizachyrium scoparium,Bouteloua curtipendula,Asclepias tuberosa,Liatris cylindracea,Solidago ptarmicoides
Rudbeckia hirta,Schizachyrium scoparium,Solidago nemoralis,Coreopsis lanceolata,Penstemon digitalis,Asclepias tuberosa
Asclepias incarnata,Iris versicolor,Eupatorium perfoliatum,Lobelia cardinalis,Chelone glabra,Carex stricta
Eupatorium perfoliatum,Iris versicolor,Lobelia cardinalis,Calamagrostis canadensis,Mimulus ringens,Carex lupulina
Spiraea alba,Calamagrostis canadensis,Iris versicolor,Asclepias incarnata,Carex stricta,Lobelia cardinalis
Chelone glabra,Iris versicolor,Lobelia siphilitica,Asclepias incarnata,Eupatorium perfoliatum,Carex vulpinoidea
Carex rosea,Polystichum acrostichoides,Aquilegia canadensis,Thalictrum dioicum,Viola sororia,Geranium maculatum
Polystichum acrostichoides,Thalictrum dioicum,Aquilegia canadensis,Carex plantaginea,Viola canadensis,Solidago flexicaulis
Thalictrum dioicum,Polystichum acrostichoides,Aquilegia canadensis,Carex plantaginea,Phlox divaricata,Viola canadensis
Gaultheria procumbens,Vaccinium angustifolium,Cornus canadensis,Mitchella repens,Polystichum acrostichoides,Carex pensylvanica
Carex sparganioides,Polystichum acrostichoides,Aquilegia canadensis,Eurybia macrophylla,Solidago flexicaulis,Thalictrum dioicum
Penstemon digitalis,Schizachyrium scoparium,Solidago nemoralis,Asclepias tuberosa,Coreopsis lanceolata,Liatris cylindracea
Symphyotrichum oolentangiense,Schizachyrium scoparium,Solidago ptarmicoides,Liatris aspera,Penstemon digitalis,Asclepias tuberosa
Diervilla lonicera,Carex pensylvanica,Gaultheria procumbens,Polystichum acrostichoides,Thalictrum dioicum,Viola sororia
Fragaria virginiana,Viola sororia,Phlox divaricata,Thalictrum dioicum,Aquilegia canadensis,Polystichum acrostichoides
Iris versicolor,Asclepias incarnata,Eupatorium perfoliatum,Lobelia cardinalis,Mimulus ringens,Carex stricta`;

        // Process the data
        const lines = csvData.trim().split('\n');
        const nodes = new Map();
        const links = [];
        const primaryPlants = new Set();
        const connectionsByPlant = new Map();

        lines.slice(1).forEach(line => {
            const parts = line.split(',');
            const primary = parts[0];
            primaryPlants.add(primary);
            
            if (!nodes.has(primary)) {
                nodes.set(primary, { 
                    id: primary, 
                    type: 'primary',
                    connections: 0,
                    group: ecologicalGroups[primary] || 'other'
                });
            }
            
            const companions = [];
            for (let i = 1; i < parts.length; i++) {
                const companion = parts[i];
                if (companion) {
                    if (!nodes.has(companion)) {
                        nodes.set(companion, { 
                            id: companion, 
                            type: 'companion',
                            connections: 0,
                            group: ecologicalGroups[companion] || 'other'
                        });
                    }
                    
                    links.push({
                        source: primary,
                        target: companion
                    });
                    
                    companions.push(companion);
                    nodes.get(primary).connections++;
                    nodes.get(companion).connections++;
                }
            }
            
            connectionsByPlant.set(primary, companions);
        });

        let nodesArray = Array.from(nodes.values());
        let currentFilter = 'all';
        
        // Calculate stats
        function updateStats() {
            const visibleNodes = nodesArray.filter(n => 
                currentFilter === 'all' || n.group === currentFilter
            );
            const visiblePrimary = visibleNodes.filter(n => n.type === 'primary').length;
            const visibleCompanions = visibleNodes.filter(n => n.type === 'companion').length;
            const visibleLinks = links.filter(l => {
                const sourceNode = nodes.get(typeof l.source === 'object' ? l.source.id : l.source);
                const targetNode = nodes.get(typeof l.target === 'object' ? l.target.id : l.target);
                return (currentFilter === 'all' || 
                    sourceNode.group === currentFilter || 
                    targetNode.group === currentFilter);
            }).length;
            
            document.getElementById('stats').innerHTML = `
                <strong>Showing:</strong> 
                ${visiblePrimary} primary plants, 
                ${visibleCompanions} companions, 
                ${visibleLinks} connections
            `;
        }
        
        updateStats();

        // Set up SVG
        const width = window.innerWidth - 390;
        const height = window.innerHeight - 180;
        
        const svg = d3.select('#graph')
            .attr('width', width)
            .attr('height', height);

        let link, node, label, simulation;

        function initGraph() {
            svg.selectAll('*').remove();
            
            const filteredNodes = currentFilter === 'all' ? 
                nodesArray : 
                nodesArray.filter(n => n.group === currentFilter);
            
            const filteredLinks = currentFilter === 'all' ?
                links :
                links.filter(l => {
                    const sourceNode = nodes.get(typeof l.source === 'object' ? l.source.id : l.source);
                    const targetNode = nodes.get(typeof l.target === 'object' ? l.target.id : l.target);
                    return sourceNode.group === currentFilter || targetNode.group === currentFilter;
                });

            simulation = d3.forceSimulation(filteredNodes)
                .force('link', d3.forceLink(filteredLinks)
                    .id(d => d.id)
                    .distance(80)
                    .strength(0.5))
                .force('charge', d3.forceManyBody()
                    .strength(-350))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(35))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));

            link = svg.append('g')
                .selectAll('line')
                .data(filteredLinks)
                .join('line')
                .attr('class', 'link');

            node = svg.append('g')
                .selectAll('circle')
                .data(filteredNodes)
                .join('circle')
                .attr('class', d => `node ${d.type}`)
                .attr('r', d => d.type === 'primary' ? 8 : 6)
                .call(drag(simulation));

            label = svg.append('g')
                .selectAll('text')
                .data(filteredNodes)
                .join('text')
                .text(d => {
                    const parts = d.id.split(' ');
                    return parts[0] + (parts[1] ? ' ' + parts[1].substring(0, 4) + '.' : '');
                })
                .attr('dy', -12)
                .style('font-size', d => d.type === 'primary' ? '11px' : '9px')
                .style('font-weight', d => d.type === 'primary' ? 'bold' : 'normal');

            node.on('click', function(event, d) {
                showPlantDetails(d);
                
                node.classed('highlighted', false);
                link.classed('highlighted', false);
                
                d3.select(this).classed('highlighted', true);
                
                link.each(function(l) {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    
                    if (sourceId === d.id || targetId === d.id) {
                        d3.select(this).classed('highlighted', true);
                        node.filter(n => n.id === sourceId || n.id === targetId)
                            .classed('highlighted', true);
                    }
                });
            });

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function showPlantDetails(plant) {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('empty');
            
            const companions = connectionsByPlant.get(plant.id) || [];
            const connectedTo = [];
            
            links.forEach(l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                
                if (sourceId === plant.id && !companions.includes(targetId)) {
                    connectedTo.push(targetId);
                } else if (targetId === plant.id && !companions.includes(sourceId)) {
                    connectedTo.push(sourceId);
                }
            });
            
            const groupName = groupNames[plant.group] || 'Other';
            const groupColor = groupColors[plant.group] || '#6b7280';
            
            let html = `
                <div class="plant-detail">
                    <div class="plant-name">${plant.id}</div>
                    <span class="plant-type ${plant.type}">${plant.type === 'primary' ? 'Primary Plant' : 'Companion Plant'}</span>
                    <br>
                    <span class="ecological-group" style="background: ${groupColor}22; color: ${groupColor};">${groupName}</span>
                    <div style="margin-top: 12px; font-size: 13px; color: #6b7280;">
                        <strong>${plant.connections}</strong> total connections in network
                    </div>
                </div>
            `;
            
            if (companions.length > 0) {
                html += `
                    <div class="connections-list">
                        <strong style="color: #1f2937; font-size: 14px;">Curated Companions:</strong>
                        ${companions.map(c => {
                            const companionNode = nodes.get(c);
                            const cGroupName = groupNames[companionNode.group] || 'Other';
                            const cGroupColor = groupColors[companionNode.group] || '#6b7280';
                            return `
                                <div class="connection-item" onclick="highlightPlant('${c}')">
                                    <div class="connection-name">${c}</div>
                                    <div class="connection-meta">
                                        <span class="ecological-group" style="background: ${cGroupColor}22; color: ${cGroupColor}; font-size: 10px;">${cGroupName}</span>
                                        <span>${companionNode.connections} connections</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            if (connectedTo.length > 0) {
                html += `
                    <div class="connections-list" style="margin-top: 20px;">
                        <strong style="color: #1f2937; font-size: 14px;">Also appears as companion for:</strong>
                        ${connectedTo.map(c => {
                            const companionNode = nodes.get(c);
                            const cGroupName = groupNames[companionNode.group] || 'Other';
                            const cGroupColor = groupColors[companionNode.group] || '#6b7280';
                            return `
                                <div class="connection-item" onclick="highlightPlant('${c}')">
                                    <div class="connection-name">${c}</div>
                                    <div class="connection-meta">
                                        <span class="ecological-group" style="background: ${cGroupColor}22; color: ${cGroupColor}; font-size: 10px;">${cGroupName}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            sidebar.innerHTML = html;
        }

        window.highlightPlant = function(plantId) {
            const plantNode = nodes.get(plantId);
            if (plantNode) {
                showPlantDetails(plantNode);
                
                node.classed('highlighted', false);
                link.classed('highlighted', false);
                
                node.filter(n => n.id === plantId).classed('highlighted', true);
                
                link.each(function(l) {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    
                    if (sourceId === plantId || targetId === plantId) {
                        d3.select(this).classed('highlighted', true);
                        node.filter(n => n.id === sourceId || n.id === targetId)
                            .classed('highlighted', true);
                    }
                });
            }
        };

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                currentFilter = this.dataset.group;
                updateStats();
                initGraph();
                
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('empty');
                sidebar.innerHTML = '<p>Click a plant node to view its companions and ecological relationships</p>';
            });
        });

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        initGraph();
    </script>
</body>
</html>
